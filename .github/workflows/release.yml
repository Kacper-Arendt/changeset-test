name: Release

on:
  push:
    branches:
      - master

concurrency: ${{ github.workflow }}-${{ github.ref }}
env:
  AZURE_TOKEN: ${{ secrets.AZURE_TOKEN }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Corepack makes sure to use correct Node.js version for your project, it requires having "engines" specified in package.json file
      # Read more about Corepack and advanced dependencies caching at: https://infinum.com/handbook/frontend/node/managing-node-npm-versions
      - name: 🗃️ Enable corepack
        run: corepack enable
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Configure npm for Azure Artifacts
        run: |
          echo "; begin auth token" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/registry/:username=kacperarendt" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/registry/:_password=${AZURE_TOKEN}" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/registry/:email=npm requires email to be set but doesn't use the value" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/:username=kacperarendt" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/:_password=${AZURE_TOKEN}" >> ~/.npmrc
          echo "//pkgs.dev.azure.com/kacperarendt/_packaging/kacperarendt/npm/:email=npm requires email to be set but doesn't use the value" >> ~/.npmrc
          echo "; end auth token" >> ~/.npmrc

      - name: Install Dependencies
        run: pnpm install --prod --frozen-lockfile

      - name: Create Release Pull Request or Publish to npm registry
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm exec changeset publish
        env:
          # GITHUB_TOKEN is required for creating a pull request and will be provided by the Github Action automatically
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push git tag after publish
        if: steps.changesets.outputs.published == 'true'
        run: git push --follow-tags